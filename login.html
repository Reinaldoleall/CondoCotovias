<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login - Sistema de Encomendas</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<meta name="theme-color" content="#2c3e50">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
    <style>
:root {
    --cor-primaria: #2c3e50;       /* Azul escuro */
    --cor-secundaria: #3498db;     /* Azul principal */
    --cor-sucesso: #27ae60;        /* Verde */
    --cor-alerta: #f39c12;         /* Laranja */
    --cor-erro: #e74c3c;           /* Vermelho */
    --cor-fundo: #f8fafc;          /* Cinza muito claro */
    --cor-texto: #2d3436;          /* Texto escuro */
    --cor-texto-secundario: #636e72; /* Texto cinza */
    --cor-borda: #dfe6e9;          /* Bordas claras */
    --sombra-card: 0 4px 6px rgba(0, 0, 0, 0.05);
    --sombra-card-hover: 0 6px 12px rgba(0, 0, 0, 0.1);
    --fonte-principal: 'Roboto', 'Segoe UI', sans-serif;
}

body {
    font-family: var(--fonte-principal);
    background-color: var(--cor-fundo);
    color: var(--cor-texto);
    line-height: 1.6;
    display: flex;
    min-height: 100vh;
    flex-direction: column;
    margin: 0;
    padding: 0;
}

        body {
  background-image: url('img/IMG-20250529-WA0015.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
  }
    
    h1, h2, h3, h4, h5, h6 {
        font-weight: 500;
        margin-bottom: 1rem;
        color: var(--primary-dark);
    }

    p {
        margin-bottom: 1rem;
    }

    a {
        color: var(--primary-color);
        text-decoration: none;
        transition: color 0.3s;
    }
    
    body {
        background-color: var(--background);
        font-family: 'Roboto', sans-serif;
    }

    .container {
        margin-top: 50px;
    }

    /* Card de login */
    .card {
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        position: relative;
    }

    .card-title {
        font-size: 1.8rem !important;
        margin-bottom: 2rem !important;
        color: #1565c0;
    }

    /* Botão de login */
    #btnLogin {
        margin-top: 20px;
        transition: all 0.3s;
    }

    #btnLogin:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #btnLogin:disabled {
        background-color: #cccccc !important;
        transform: none !important;
        box-shadow: none !important;
    }

    /* Links */
    #esqueciSenha, .register-link {
        color: #1565c0;
        transition: color 0.3s;
    }

    #esqueciSenha:hover, .register-link:hover {
        color: #0d47a1;
        text-decoration: underline;
    }

    /* Mensagens de erro/sucesso - agora dentro do card */
    .message-container {
        padding: 10px 15px;
        margin: 15px 0 0 0;
        border-radius: 4px;
        display: none;
    }

    .error-message {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
    }

    .success-message {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }

    /* Responsividade */
    @media (max-width: 600px) {
        .container {
            width: 95%;
        }
        
        .card-title {
            font-size: 1.5rem !important;
        }
    }
    </style>
</head>
<body>
<br><br><br><br>

    <div class="container">
        <div class="section">
            <div class="row">
                <div class="col s12 m6 offset-m3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title center-align"><h4>Login</h4></span>
                            
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">email</i>
                                    <input id="email" type="email" class="validate" required>
                                    <label for="email">Email</label>
                                    <span class="helper-text" data-error="Email inválido"></span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">lock</i>
                                    <input id="senha" type="password" class="validate" required>
                                    <label for="senha">Senha</label>
                                    <span class="helper-text" data-error="Mínimo 6 caracteres"></span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12 center-align">
                                    <button id="btnLogin" class="btn waves-effect waves-light blue darken-3">Entrar
                                        <i class="material-icons right">send</i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12 center-align">
                                    <a href="#" id="esqueciSenha">Esqueci minha senha</a>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12 center-align">
                                    Não tem uma conta? <a href="cadastro.html" class="register-link">Cadastre-se</a>
                                </div>
                            </div>
                            
                            <!-- Container para mensagens (agora dentro do card, na base) -->
                            <div id="messageContainer" class="message-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Configuração do Firebase
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyByyM8RvGNM5pyrQIQ7nCH6mmgYAIpq0bc",
  authDomain: "rifas-c414b.firebaseapp.com",
  databaseURL: "https://rifas-c414b-default-rtdb.firebaseio.com",
  projectId: "rifas-c414b",
  storageBucket: "rifas-c414b.firebasestorage.app",
  messagingSenderId: "770195193538",
  appId: "1:770195193538:web:48e585ac5661d27f3dc55b"
};

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Elementos do DOM
        const emailInput = document.getElementById('email');
        const senhaInput = document.getElementById('senha');
        const btnLogin = document.getElementById('btnLogin');
        const esqueciSenha = document.getElementById('esqueciSenha');
        const messageContainer = document.getElementById('messageContainer');

        // Inicializa os componentes do Materialize
        document.addEventListener('DOMContentLoaded', function() {
            M.updateTextFields(); // Atualiza campos de texto
            
            // Verifica se o usuário já está logado
            checkAuthState();
            
            // Configura eventos
            setupEventListeners();
        });

        // Verifica o estado de autenticação
        function checkAuthState() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const userSnapshot = await database.ref('users/' + user.uid).once('value');
                        const userData = userSnapshot.val();
                        
                        if (userData) {
                            console.log("Usuário já logado - Tipo:", userData.tipo);
                            redirectUser(userData.tipo);
                        }
                    } catch (error) {
                        console.error("Erro ao verificar tipo de usuário:", error);
                        showError("Erro ao verificar dados do usuário");
                    }
                }
            });
        }

        // Função corrigida para redirecionar o usuário
        function redirectUser(userType) {
            console.log("Redirecionando usuário do tipo:", userType);
            
            // Verifica se o tipo de usuário está definido
            if (!userType) {
                console.error("Tipo de usuário não definido");
                showError("Tipo de usuário não identificado");
                return;
            }
            
            // Redireciona conforme o tipo de usuário
            if (userType.toLowerCase() === 'morador') {
                window.location.href = 'usuario.html';
            } else if (userType.toLowerCase() === 'portaria') {
                window.location.href = 'portaria.html';
            } else {
                console.error("Tipo de usuário desconhecido:", userType);
                showError("Tipo de usuário não suportado");
            }
        }

        // Configura os eventos
        function setupEventListeners() {
            // Evento de login
            btnLogin.addEventListener('click', handleLogin);
            
            // Evento de recuperação de senha
            esqueciSenha.addEventListener('click', handlePasswordRecovery);
            
            // Validação ao sair do campo (blur)
            emailInput.addEventListener('blur', validateEmail);
            senhaInput.addEventListener('blur', validatePassword);
        }

        // Validação de email
        function validateEmail() {
            const email = emailInput.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email) {
                return false;
            }
            
            if (!emailRegex.test(email)) {
                emailInput.classList.add('invalid');
                return false;
            }
            
            emailInput.classList.remove('invalid');
            return true;
        }

        // Validação de senha
        function validatePassword() {
            const senha = senhaInput.value;
            
            if (!senha) {
                return false;
            }
            
            if (senha.length < 6) {
                senhaInput.classList.add('invalid');
                return false;
            }
            
            senhaInput.classList.remove('invalid');
            return true;
        }

        // Validação do formulário completo
        function validateForm() {
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePassword();
            
            return isEmailValid && isPasswordValid;
        }

        // Manipulador de login
        async function handleLogin(e) {
            e.preventDefault();
            
            // Limpa mensagens anteriores
            clearMessages();
            
            // Valida o formulário
            if (!validateForm()) {
                showError('Por favor, corrija os campos destacados');
                return;
            }
            
            const email = emailInput.value.trim();
            const senha = senhaInput.value;
            
            try {
                // Mostra loading no botão
                btnLogin.disabled = true;
                btnLogin.innerHTML = '<i class="material-icons left">cached</i> Entrando...';
                
                // Faz login
                const userCredential = await auth.signInWithEmailAndPassword(email, senha);
                
                // Obtém os dados do usuário
                const userSnapshot = await database.ref('users/' + userCredential.user.uid).once('value');
                
                if (!userSnapshot.exists()) {
                    throw new Error("Dados do usuário não encontrados");
                }
                
                const userData = userSnapshot.val();
                
                if (!userData.tipo) {
                    throw new Error("Tipo de usuário não definido");
                }
                
                console.log("Login bem-sucedido - Dados do usuário:", userData);
                
                // Mostra mensagem de sucesso
                showSuccess('Login realizado com sucesso!');
                
                // Redireciona conforme o tipo de usuário
                setTimeout(() => {
                    redirectUser(userData.tipo);
                }, 1000);
                
            } catch (error) {
                console.error("Erro no login:", error);
                
                // Restaura o botão
                btnLogin.disabled = false;
                btnLogin.innerHTML = 'Entrar <i class="material-icons right">send</i>';
                
                // Mostra mensagem de erro
                handleAuthError(error);
            }
        }

        // Manipulador de recuperação de senha
        async function handlePasswordRecovery(e) {
            e.preventDefault();
            clearMessages();
            
            const email = emailInput.value.trim();
            
            if (!email) {
                showError('Por favor, informe seu email para recuperar a senha');
                return;
            }
            
            if (!validateEmail()) {
                showError('Por favor, insira um email válido');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                showSuccess('Email de recuperação enviado. Verifique sua caixa de entrada.');
            } catch (error) {
                handleAuthError(error);
            }
        }

        // Manipulador de erros de autenticação
        function handleAuthError(error) {
            let errorMessage = 'Erro ao autenticar';
            
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage = 'Email inválido';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'Conta desativada';
                    break;
                case 'auth/user-not-found':
                    errorMessage = 'Usuário não encontrado';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'Senha incorreta';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Muitas tentativas. Tente novamente mais tarde.';
                    break;
                default:
                    errorMessage = error.message || 'Erro desconhecido';
            }
            
            showError(errorMessage);
        }

        // Mostra mensagem de erro
        function showError(message) {
            messageContainer.textContent = message;
            messageContainer.className = 'message-container error-message';
            messageContainer.style.display = 'block';
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }

        // Mostra mensagem de sucesso
        function showSuccess(message) {
            messageContainer.textContent = message;
            messageContainer.className = 'message-container success-message';
            messageContainer.style.display = 'block';
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }

        // Limpa as mensagens
        function clearMessages() {
            messageContainer.style.display = 'none';
        }
    </script>
</body>
</html>
